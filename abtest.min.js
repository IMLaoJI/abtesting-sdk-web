!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():t()}(this,function(){"use strict";var e={},t={sd:null,lib_version:"0.1.1",para:{},default_para:{url:"",path:"",project_key:"",timeout_milliseconds:3e3,update_interval:6e5,collect_bridge_status:!0},value_type_list:["Number","String","Object","Boolean"],state:{platform:"",storage:{isSupport:!0,name:"sawebjssdkabtest"}},bridgeState:"",localdata:[],localExpID:[],trackTestTrigger:function(a,s){var i={$abtest_experiment_id:a.abtest_experiment_id,$abtest_experiment_group_id:a.abtest_experiment_group_id};t.para.collect_bridge_status&&(i.$sdk_bridge_status=t.bridgeState);var r=e.extend(i,s);this.sd.track("$ABTestTrigger",r)},verifyStore:{valueType:function(t,a){switch(a){case"Number":if(e.isNumber(t))return!0;break;case"String":if(e.isString(t))return!0;break;case"Object":if(e.isObject(t))return!0;break;case"Boolean":if(t===!0||t===!1)return!0;break;default:return!1}return!1},para:function(a,s,i){var r={verify_success:!0,para:null};return e.each(i,function(i,o){if("essential"===i)switch(o){case"experiment_id":e.isString(s.experiment_id)&&s.experiment_id.length>0||(t.error(a+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cexperiment_id\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01experiment_id:",s.experiment_id),r.verify_success=!1);break;case"value_type":e.isString(s.value_type)&&e.indexOf(t.value_type_list,s.value_type)!==-1||(t.error(a+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",s.value_type),r.verify_success=!1);break;case"default_value":"undefined"==typeof s.default_value?(t.error(a+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),r.verify_success=!1):t.verifyStore.valueType(s.default_value,s.value_type)||(t.error(a+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",s.default_value,s.value_type),r.verify_success=!1);break;default:r.verify_success=!1}else if("not_essential"===i)switch(o){case"callback":e.isFunction(s.callback)||(s.callback=function(){},t.error(a+"callback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"));break;case"timeout_milliseconds":s.timeout_milliseconds=s.timeout_milliseconds||t.para.timeout_milliseconds||t.default_para.timeout_milliseconds,(!e.isNumber(s.timeout_milliseconds)||e.isNumber(s.timeout_milliseconds)&&s.timeout_milliseconds<=0)&&(e.log("timeout_milliseconds \u53c2\u6570\u9519\u8bef",s.timeout_milliseconds),s.timeout_milliseconds=t.para.timeout_milliseconds),s.timeout_milliseconds<100&&(s.timeout_milliseconds=100);break;case"properties":s.properties=e.isObject(s.properties)?s.properties:{}}}),r.para=s,r}},dealResponseData:function(a){e.isObject(a)?"SUCCESS"===a.status?e.isArray(a.results)&&(e.each(a.results,function(a){e.isObject(a)&&e.isObject(a.config)&&(a.js_config=t.getRelativeValue(a.config.variables,a.config.type))}),this.updateLocalData(a.results)):"FAILED"===a.status&&e.log("\u83b7\u53d6\u8bd5\u9a8c\u5931\u8d25\uff1aerror_type\uff1a"+a.error_type+",error\uff1a"+a.error):e.log("\u8bd5\u9a8c\u6570\u636e\u89e3\u6790\u5931\u8d25\uff0cresponse \uff1a",a)},getRelativeValue:function(t,a){var s={},i={INTEGER:function(t){var a=parseFloat(t);isNaN(a)?e.log("\u670d\u52a1\u7aef\u6570\u636eINTEGER\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t):(s.value=a,s.type="Number")},STRING:function(t){e.isString(t)?(s.value=t,s.type="String"):e.log("\u670d\u52a1\u7aef\u6570\u636eSTRING\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)},JSON:function(t){var a=JSON.parse(t);e.isObject(a)?(s.value=a,s.type="Object"):e.log("\u670d\u52a1\u7aef\u6570\u636eJSON\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)},BOOLEAN:function(t){"true"===t?(s.value=!0,s.type="Boolean"):"false"===t?(s.value=!1,s.type="Boolean"):e.log("\u670d\u52a1\u7aef\u6570\u636eBOOLEAN\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)}};try{i[a]?i[a](t):e.log("\u8bd5\u9a8c\u6570\u636e\u7c7b\u578b\u89e3\u6790\u5931\u8d25",a,t)}catch(r){e.log(r,t,a)}return s},getStorageKey:function(){return this.state.storage.name},updateLocalData:function(t){if(this.saveLocalData(t),this.state.storage.isSupport){var a=(new Date).getTime(),s={data:t,updateTime:a};window.localStorage.setItem(this.getStorageKey(),JSON.stringify(s))}e.log("\u66f4\u65b0\u8bd5\u9a8c\u6570\u636e\u6210\u529f")},saveLocalData:function(a){this.localdata=a,t.localExpID=[],e.each(a,function(e){e.abtest_experiment_id&&t.localExpID.push(e.abtest_experiment_id)})},initMethods:function(a){var s=["asyncFetchABTest","fastFetchABTest","fetchCacheABTest"];e.each(s,function(e){t[e]=a.methods[e]})},asyncFetchABTest:function(){t.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},fastFetchABTest:function(){t.error("fastFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},fetchCacheABTest:function(){t.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},getLocalABTestList:function(){return this.localExpID},initFetch:function(a,s){var i=null;if(t.state.storage.isSupport&&(i=window.localStorage.getItem(t.getStorageKey())),i){i=JSON.parse(i),this.saveLocalData(i.data);var r=i.updateTime,o=(new Date).getTime();(e.isNumber(r)&&o-r>=this.para.update_interval||o-r<=0||!e.isNumber(r))&&(e.log("\u521d\u59cb\u5316 SDK\uff0c\u5c1d\u8bd5\u83b7\u53d6\u8bd5\u9a8c\u6570\u636e",r,o),a.call(s))}else e.log("\u521d\u59cb\u5316 SDK\uff0c\u5c1d\u8bd5\u83b7\u53d6\u8bd5\u9a8c\u6570\u636e"),a.call(s);setInterval(function(){a.call(s)},t.para.update_interval)},searchLocalExp:function(a){var s=null;return e.each(t.localdata,function(t){e.isObject(t)&&t.abtest_experiment_id===a&&(s=t)}),s},getExpResult:function(a,s){var i=a.default_value,s=s?s:t.searchLocalExp(a.experiment_id);return e.isObject(s)?e.isObject(s.js_config)&&(s.js_config.type===a.value_type?(i=s.js_config.value,s.is_white_list||t.trackTestTrigger(s,a.properties)):this.log("\u8bd5\u9a8c\u7ed3\u679c\u7c7b\u578b\u4e0e\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e0d\u4e00\u81f4\uff0cexperiment_id\uff1a"+a.experiment_id+"\uff0c\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\u4e3a\uff1a"+s.js_config.type+"\uff0c\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e3a\uff1a"+a.value_type)):this.log("localdata\u672a\u67e5\u8be2\u5230\u8bd5\u9a8c\u6570\u636e\uff0c\u8bd5\u9a8cID\uff1a"+a.experiment_id),i},getSA:function(t){return!!(e.isObject(t)&&e.isObject(t.readyState)&&t.readyState.state>=3)&&(this.sd=t,!0)},log:function(){if("object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}},error:function(){if("object"==typeof console&&console.error)try{return console.error.apply(console,arguments)}catch(e){console.error(arguments[0])}},checkSADebug:function(){var a=e.getQueryParam(location.href,"sensors_abtest_url"),s=e.getQueryParam(location.href,"feature_code"),i=+e.getQueryParam(location.href,"account_id");if(a.length&&s.length&&e.isNumber(i)&&0!==i){var r={distinct_id:t.sd.store.getDistinctId(),feature_code:s,account_id:i};e.ajax({url:a,type:"POST",data:JSON.stringify(r),credentials:!1,contentType:"application/json",timeout:t.para.timeout_milliseconds,cors:!0,success:function(){},error:function(t){e.log("distinct_id\u53d1\u9001\u5931\u8d25,err:",t)}})}},init:function(t,a){return this.sd?(this.log("A/B Testing SDK \u91cd\u590d\u521d\u59cb\u5316\uff01\u53ea\u6709\u7b2c\u4e00\u6b21\u521d\u59cb\u5316\u6709\u6548\uff01"),!1):(e=t._,e.log=t.log,this.getSA(t)?e.isObject(a)?("object"==typeof localStorage&&this.sd._.localStorage.isSupport()||(e.log("localstorage\u5f02\u5e38"),this.state.storage.isSupport=!1),void(t.bridge.is_verify_success?this.bridgeStore.init(a):this.normalStore.init(a))):(e.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f20\u5165\u6b63\u786e\u7684\u521d\u59cb\u5316\u53c2\u6570!para:",a),!1):(this.log("A/B Testing \u521d\u59cb\u5316\u5931\u8d25,Web JS SDK \u6ca1\u6709\u521d\u59cb\u5316\u5b8c\u6210"),!1))},bridgeStore:{init:function(a){return!!this.setPara(a)&&(e.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f"),t.state.storage.name="sawebjssdkabtest_bridge",t.abBridge=new t.sd.JSBridge({type:"abtest",app_call_js:function(e){e=JSON.parse(e),e.message_id&&this["double"](e)}}),e.isObject(window.SensorsData_iOS_JS_Bridge)&&window.SensorsData_iOS_JS_Bridge.sensorsdata_abtest_module&&t.abBridge.hasAppBridge()?t.bridgeState="ab_bridge_ok":e.isObject(window.SensorsData_APP_New_H5_Bridge)&&e.isFunction(window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module)&&window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module()&&t.abBridge.hasAppBridge()?t.bridgeState="ab_bridge_ok":t.bridgeState="ab_no_abtest_bridge",t.initFetch(this.getResultFromApp,this),void t.initMethods(this))},setPara:function(a){var s=t.verifyStore.para("\u6253\u901a\u521d\u59cb\u5316",a,{timeout_milliseconds:"not_essential"});return t.para=e.extend({},t.default_para,s.para),e.isBoolean(t.para.collect_bridge_status)||(t.para.collect_bridge_status=!0),e.isNumber(t.para.update_interval)||(t.para.update_interval=6e5),!0},getResultFromApp:function(a){function s(){"ab_bridge_ok"===t.bridgeState?t.abBridge.requestToApp({data:{properties:i.properties,timeout:n},callback:function(a){e.isObject(a)&&e.isObject(a.data)?(e.log("\u6210\u529f\u83b7\u53d6\u5230 App \u7aef\u8fd4\u56de\u7684\u8bd5\u9a8c\u6570\u636e","data:",a),t.dealResponseData(a.data),r&&r(a)):(e.log("App \u7aef\u8bf7\u6c42\u5931\u8d25"),o&&o())},timeout:{time:n,callback:function(){e.log("\u83b7\u53d6App\u7aef\u6570\u636e\u5931\u8d25"),o&&o()}}}):o&&(e.log("A/B Testing \u6253\u901a\u5931\u8d25\uff0c",t.bridgeState),o())}a=e.isObject(a)?a:{};var i=a.para||{},r=a.suc,o=a.err,n=i.timeout_milliseconds||t.para.timeout_milliseconds;s()},asyncFetch:function(a){t.bridgeStore.getResultFromApp({para:a,suc:function(s){if(e.isObject(s.properties)&&(a.properties=e.extend(s.properties,a.properties)),"SUCCESS"===s.data.status){var i=t.getExpResult(a);a.callback(i)}else a.callback(a.default_value)},err:function(){a.callback(a.default_value)}})},methods:{asyncFetchABTest:function(a){if(!e.isObject(a))return t.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var s=t.verifyStore.para("asyncFetchABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});s.verify_success&&(a=s.para,"ab_bridge_ok"===t.bridgeState?t.bridgeStore.asyncFetch(a):a.callback(a.default_value))},fastFetchABTest:function(a){if(!e.isObject(a))return t.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var s=t.verifyStore.para("fastFetchABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(s.verify_success){a=s.para;var i=t.searchLocalExp(a.experiment_id);if(e.isObject(i)){var r=t.getExpResult(a,i);a.callback(r)}else e.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),"ab_bridge_ok"===t.bridgeState?t.bridgeStore.asyncFetch(a):a.callback(a.default_value)}},fetchCacheABTest:function(a){if(!e.isObject(a))return void t.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e");var s=t.verifyStore.para("fetchCacheABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential"});if(s.verify_success)return t.getExpResult(s.para)}}},normalStore:{init:function(a){return!!this.setPara(a)&&(t.bridgeState="ab_no_host_bridge",/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)?t.state.platform="H5":t.state.platform="Web",e.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f\uff0c\u8bd5\u9a8c URL\uff1a",a.url),t.checkSADebug(),t.initFetch(this.getResultFromServer,this),void t.initMethods(this))},setPara:function(a){if(!e.isString(a.url)||"http"!==a.url.slice(0,4))return e.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1;if("https"===location.protocol.slice(0,4)&&"http"===a.url.slice(0,4))return e.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0chttps \u9875\u9762\u5fc5\u987b\u4f7f\u7528 https \u7684 URL"),!1;var s=e.getQueryParam(a.url,"project-key");if(!s)return e.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff08\u5fc5\u987b\u5305\u542b project-key\uff09\uff01"),!1;a.project_key=s;var i=t.verifyStore.para("A/B Testing SDK \u521d\u59cb\u5316",a,{timeout_milliseconds:"not_essential"});return t.para=e.extend({},t.default_para,i.para),e.isBoolean(t.para.collect_bridge_status)||(t.para.collect_bridge_status=!0),e.isNumber(t.para.update_interval)||(t.para.update_interval=6e5),!0},asyncFetch:function(a){t.normalStore.getResultFromServer({para:a,suc:function(s){if(e.isObject(s)&&"SUCCESS"===s.status){var i=t.getExpResult(a);a.callback(i)}else a.callback(a.default_value)},err:function(){a.callback(a.default_value)}})},methods:{asyncFetchABTest:function(a){if(!e.isObject(a))return t.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var s=t.verifyStore.para("asyncFetchABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});s.verify_success&&(a=s.para,t.normalStore.asyncFetch(a))},fastFetchABTest:function(a){if(!e.isObject(a))return t.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var s=t.verifyStore.para("fastFetchABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(s.verify_success){a=s.para;var i=t.searchLocalExp(a.experiment_id);if(e.isObject(i)){var r=t.getExpResult(a,i);a.callback(r)}else e.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),t.normalStore.asyncFetch(a)}},fetchCacheABTest:function(a){if(!e.isObject(a))return void t.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e");var s=t.verifyStore.para("fetchCacheABTest",a,{experiment_id:"essential",value_type:"essential",default_value:"essential"});if(s.verify_success)return t.getExpResult(s.para)}},creatRequestData:function(a){var s="";e.isEmptyObject(t.sd.store._state)||(s=t.sd.store._state._first_id||t.sd.store._state.first_id||t.sd.store._state._distinct_id||t.sd.store._state.distinct_id);var i={anonymous_id:s,platform:t.state.platform,properties:{$is_first_day:e.cookie.getNewUser()}};return e.isObject(a.properties)&&(i.properties=e.extend({},i.properties,a.properties)),t.sd.store._state.first_id&&(i.login_id=t.sd.store.getDistinctId()),i},getResultFromServer:function(a){function s(){e.ajax({url:t.para.url,type:"POST",data:JSON.stringify(n),credentials:!1,contentType:"application/json",timeout:i.timeout_milliseconds||t.para.timeout_milliseconds,cors:!0,success:function(a){e.log("\u83b7\u53d6\u5230\u670d\u52a1\u7aef\u6570\u636e",a),t.dealResponseData(a),r&&r(a)},error:function(t){e.log("\u670d\u52a1\u7aef\u8bf7\u6c42\u53d1\u9001\u5931\u8d25",t),o&&o()}})}a=e.isObject(a)?a:{};var i=a.para||{},r=a.suc,o=a.err,n=this.creatRequestData(i);s()}}};return window.SensorsDataWebJSSDKPlugin&&"[object Object]"==Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.SensorsABTest=window.SensorsDataWebJSSDKPlugin.SensorsABTest||t:window.SensorsDataWebJSSDKPlugin={SensorsABTest:t},t});