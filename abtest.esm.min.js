var _={},SensorsABTest={sd:null,lib_version:"0.1.1",para:{},default_para:{url:"",path:"",project_key:"",timeout_milliseconds:3e3,update_interval:6e5,collect_bridge_status:!0},value_type_list:["Number","String","Object","Boolean"],state:{platform:"",storage:{isSupport:!0,name:"sawebjssdkabtest"}},bridgeState:"",localdata:[],localExpID:[],trackTestTrigger:function(e,t){var s={$abtest_experiment_id:e.abtest_experiment_id,$abtest_experiment_group_id:e.abtest_experiment_group_id};SensorsABTest.para.collect_bridge_status&&(s.$sdk_bridge_status=SensorsABTest.bridgeState);var r=_.extend(s,t);this.sd.track("$ABTestTrigger",r)},verifyStore:{valueType:function(e,t){switch(t){case"Number":if(_.isNumber(e))return!0;break;case"String":if(_.isString(e))return!0;break;case"Object":if(_.isObject(e))return!0;break;case"Boolean":if(!0===e||!1===e)return!0;break;default:return!1}return!1},para:function(e,t,s){var r={verify_success:!0,para:null};return _.each(s,function(s,a){if("essential"===s)switch(a){case"experiment_id":_.isString(t.experiment_id)&&t.experiment_id.length>0||(SensorsABTest.error(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cexperiment_id\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01experiment_id:",t.experiment_id),r.verify_success=!1);break;case"value_type":_.isString(t.value_type)&&-1!==_.indexOf(SensorsABTest.value_type_list,t.value_type)||(SensorsABTest.error(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",t.value_type),r.verify_success=!1);break;case"default_value":void 0===t.default_value?(SensorsABTest.error(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),r.verify_success=!1):SensorsABTest.verifyStore.valueType(t.default_value,t.value_type)||(SensorsABTest.error(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",t.default_value,t.value_type),r.verify_success=!1);break;default:r.verify_success=!1}else if("not_essential"===s)switch(a){case"callback":_.isFunction(t.callback)||(t.callback=function(){},SensorsABTest.error(e+"callback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"));break;case"timeout_milliseconds":t.timeout_milliseconds=t.timeout_milliseconds||SensorsABTest.para.timeout_milliseconds||SensorsABTest.default_para.timeout_milliseconds,(!_.isNumber(t.timeout_milliseconds)||_.isNumber(t.timeout_milliseconds)&&t.timeout_milliseconds<=0)&&(_.log("timeout_milliseconds \u53c2\u6570\u9519\u8bef",t.timeout_milliseconds),t.timeout_milliseconds=SensorsABTest.para.timeout_milliseconds),t.timeout_milliseconds<100&&(t.timeout_milliseconds=100);break;case"properties":t.properties=_.isObject(t.properties)?t.properties:{}}}),r.para=t,r}},dealResponseData:function(e){_.isObject(e)?"SUCCESS"===e.status?_.isArray(e.results)&&(_.each(e.results,function(e){_.isObject(e)&&_.isObject(e.config)&&(e.js_config=SensorsABTest.getRelativeValue(e.config.variables,e.config.type))}),this.updateLocalData(e.results)):"FAILED"===e.status&&_.log("\u83b7\u53d6\u8bd5\u9a8c\u5931\u8d25\uff1aerror_type\uff1a"+e.error_type+",error\uff1a"+e.error):_.log("\u8bd5\u9a8c\u6570\u636e\u89e3\u6790\u5931\u8d25\uff0cresponse \uff1a",e)},getRelativeValue:function(e,t){var s={},r={INTEGER:function(e){var t=parseFloat(e);isNaN(t)?_.log("\u670d\u52a1\u7aef\u6570\u636eINTEGER\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e):(s.value=t,s.type="Number")},STRING:function(e){_.isString(e)?(s.value=e,s.type="String"):_.log("\u670d\u52a1\u7aef\u6570\u636eSTRING\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)},JSON:function(e){var t=JSON.parse(e);_.isObject(t)?(s.value=t,s.type="Object"):_.log("\u670d\u52a1\u7aef\u6570\u636eJSON\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)},BOOLEAN:function(e){"true"===e?(s.value=!0,s.type="Boolean"):"false"===e?(s.value=!1,s.type="Boolean"):_.log("\u670d\u52a1\u7aef\u6570\u636eBOOLEAN\u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)}};try{r[t]?r[t](e):_.log("\u8bd5\u9a8c\u6570\u636e\u7c7b\u578b\u89e3\u6790\u5931\u8d25",t,e)}catch(s){_.log(s,e,t)}return s},getStorageKey:function(){return this.state.storage.name},updateLocalData:function(e){if(this.saveLocalData(e),this.state.storage.isSupport){var t={data:e,updateTime:(new Date).getTime()};window.localStorage.setItem(this.getStorageKey(),JSON.stringify(t))}_.log("\u66f4\u65b0\u8bd5\u9a8c\u6570\u636e\u6210\u529f")},saveLocalData:function(e){this.localdata=e,SensorsABTest.localExpID=[],_.each(e,function(e){e.abtest_experiment_id&&SensorsABTest.localExpID.push(e.abtest_experiment_id)})},initMethods:function(e){_.each(["asyncFetchABTest","fastFetchABTest","fetchCacheABTest"],function(t){SensorsABTest[t]=e.methods[t]})},asyncFetchABTest:function(){SensorsABTest.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},fastFetchABTest:function(){SensorsABTest.error("fastFetchABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},fetchCacheABTest:function(){SensorsABTest.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25,A/B Testing\u672a\u521d\u59cb\u5316")},getLocalABTestList:function(){return this.localExpID},initFetch:function(e,t){var s=null;if(SensorsABTest.state.storage.isSupport&&(s=window.localStorage.getItem(SensorsABTest.getStorageKey())),s){s=JSON.parse(s),this.saveLocalData(s.data);var r=s.updateTime,a=(new Date).getTime();(_.isNumber(r)&&a-r>=this.para.update_interval||a-r<=0||!_.isNumber(r))&&(_.log("\u521d\u59cb\u5316 SDK\uff0c\u5c1d\u8bd5\u83b7\u53d6\u8bd5\u9a8c\u6570\u636e",r,a),e.call(t))}else _.log("\u521d\u59cb\u5316 SDK\uff0c\u5c1d\u8bd5\u83b7\u53d6\u8bd5\u9a8c\u6570\u636e"),e.call(t);setInterval(function(){e.call(t)},SensorsABTest.para.update_interval)},searchLocalExp:function(e){var t=null;return _.each(SensorsABTest.localdata,function(s){_.isObject(s)&&s.abtest_experiment_id===e&&(t=s)}),t},getExpResult:function(e,t){var s=e.default_value;t=t||SensorsABTest.searchLocalExp(e.experiment_id);return _.isObject(t)?_.isObject(t.js_config)&&(t.js_config.type===e.value_type?(s=t.js_config.value,t.is_white_list||SensorsABTest.trackTestTrigger(t,e.properties)):this.log("\u8bd5\u9a8c\u7ed3\u679c\u7c7b\u578b\u4e0e\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e0d\u4e00\u81f4\uff0cexperiment_id\uff1a"+e.experiment_id+"\uff0c\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\u4e3a\uff1a"+t.js_config.type+"\uff0c\u4ee3\u7801\u671f\u671b\u7c7b\u578b\u4e3a\uff1a"+e.value_type)):this.log("localdata\u672a\u67e5\u8be2\u5230\u8bd5\u9a8c\u6570\u636e\uff0c\u8bd5\u9a8cID\uff1a"+e.experiment_id),s},getSA:function(e){return!!(_.isObject(e)&&_.isObject(e.readyState)&&e.readyState.state>=3)&&(this.sd=e,!0)},log:function(){if("object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}},error:function(){if("object"==typeof console&&console.error)try{return console.error.apply(console,arguments)}catch(e){console.error(arguments[0])}},checkSADebug:function(){var e=_.getQueryParam(location.href,"sensors_abtest_url"),t=_.getQueryParam(location.href,"feature_code"),s=+_.getQueryParam(location.href,"account_id");if(e.length&&t.length&&_.isNumber(s)&&0!==s){var r={distinct_id:SensorsABTest.sd.store.getDistinctId(),feature_code:t,account_id:s};_.ajax({url:e,type:"POST",data:JSON.stringify(r),credentials:!1,contentType:"application/json",timeout:SensorsABTest.para.timeout_milliseconds,cors:!0,success:function(){},error:function(e){_.log("distinct_id\u53d1\u9001\u5931\u8d25,err:",e)}})}},init:function(e,t){return this.sd?(this.log("A/B Testing SDK \u91cd\u590d\u521d\u59cb\u5316\uff01\u53ea\u6709\u7b2c\u4e00\u6b21\u521d\u59cb\u5316\u6709\u6548\uff01"),!1):((_=e._).log=e.log,this.getSA(e)?_.isObject(t)?("object"==typeof localStorage&&this.sd._.localStorage.isSupport()||(_.log("localstorage\u5f02\u5e38"),this.state.storage.isSupport=!1),void(e.bridge.is_verify_success?this.bridgeStore.init(t):this.normalStore.init(t))):(_.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f20\u5165\u6b63\u786e\u7684\u521d\u59cb\u5316\u53c2\u6570!para:",t),!1):(this.log("A/B Testing \u521d\u59cb\u5316\u5931\u8d25,Web JS SDK \u6ca1\u6709\u521d\u59cb\u5316\u5b8c\u6210"),!1))},bridgeStore:{init:function(e){if(!this.setPara(e))return!1;_.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f"),SensorsABTest.state.storage.name="sawebjssdkabtest_bridge",SensorsABTest.abBridge=new SensorsABTest.sd.JSBridge({type:"abtest",app_call_js:function(e){(e=JSON.parse(e)).message_id&&this.double(e)}}),_.isObject(window.SensorsData_iOS_JS_Bridge)&&window.SensorsData_iOS_JS_Bridge.sensorsdata_abtest_module&&SensorsABTest.abBridge.hasAppBridge()?SensorsABTest.bridgeState="ab_bridge_ok":_.isObject(window.SensorsData_APP_New_H5_Bridge)&&_.isFunction(window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module)&&window.SensorsData_APP_New_H5_Bridge.sensorsdata_abtest_module()&&SensorsABTest.abBridge.hasAppBridge()?SensorsABTest.bridgeState="ab_bridge_ok":SensorsABTest.bridgeState="ab_no_abtest_bridge",SensorsABTest.initFetch(this.getResultFromApp,this),SensorsABTest.initMethods(this)},setPara:function(e){var t=SensorsABTest.verifyStore.para("\u6253\u901a\u521d\u59cb\u5316",e,{timeout_milliseconds:"not_essential"});return SensorsABTest.para=_.extend({},SensorsABTest.default_para,t.para),_.isBoolean(SensorsABTest.para.collect_bridge_status)||(SensorsABTest.para.collect_bridge_status=!0),_.isNumber(SensorsABTest.para.update_interval)||(SensorsABTest.para.update_interval=6e5),!0},getResultFromApp:function(e){var t=(e=_.isObject(e)?e:{}).para||{},s=e.suc,r=e.err,a=t.timeout_milliseconds||SensorsABTest.para.timeout_milliseconds;"ab_bridge_ok"===SensorsABTest.bridgeState?SensorsABTest.abBridge.requestToApp({data:{properties:t.properties,timeout:a},callback:function(e){_.isObject(e)&&_.isObject(e.data)?(_.log("\u6210\u529f\u83b7\u53d6\u5230 App \u7aef\u8fd4\u56de\u7684\u8bd5\u9a8c\u6570\u636e","data:",e),SensorsABTest.dealResponseData(e.data),s&&s(e)):(_.log("App \u7aef\u8bf7\u6c42\u5931\u8d25"),r&&r())},timeout:{time:a,callback:function(){_.log("\u83b7\u53d6App\u7aef\u6570\u636e\u5931\u8d25"),r&&r()}}}):r&&(_.log("A/B Testing \u6253\u901a\u5931\u8d25\uff0c",SensorsABTest.bridgeState),r())},asyncFetch:function(e){SensorsABTest.bridgeStore.getResultFromApp({para:e,suc:function(t){if(_.isObject(t.properties)&&(e.properties=_.extend(t.properties,e.properties)),"SUCCESS"===t.data.status){var s=SensorsABTest.getExpResult(e);e.callback(s)}else e.callback(e.default_value)},err:function(){e.callback(e.default_value)}})},methods:{asyncFetchABTest:function(e){if(!_.isObject(e))return SensorsABTest.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var t=SensorsABTest.verifyStore.para("asyncFetchABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});t.verify_success&&(e=t.para,"ab_bridge_ok"===SensorsABTest.bridgeState?SensorsABTest.bridgeStore.asyncFetch(e):e.callback(e.default_value))},fastFetchABTest:function(e){if(!_.isObject(e))return SensorsABTest.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var t=SensorsABTest.verifyStore.para("fastFetchABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(t.verify_success){e=t.para;var s=SensorsABTest.searchLocalExp(e.experiment_id);if(_.isObject(s)){var r=SensorsABTest.getExpResult(e,s);e.callback(r)}else _.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),"ab_bridge_ok"===SensorsABTest.bridgeState?SensorsABTest.bridgeStore.asyncFetch(e):e.callback(e.default_value)}},fetchCacheABTest:function(e){if(_.isObject(e)){var t=SensorsABTest.verifyStore.para("fetchCacheABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential"});if(t.verify_success)return SensorsABTest.getExpResult(t.para)}else SensorsABTest.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e")}}},normalStore:{init:function(e){if(!this.setPara(e))return!1;SensorsABTest.bridgeState="ab_no_host_bridge",/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)?SensorsABTest.state.platform="H5":SensorsABTest.state.platform="Web",_.log("A/B Testing SDK \u521d\u59cb\u5316\u6210\u529f\uff0c\u8bd5\u9a8c URL\uff1a",e.url),SensorsABTest.checkSADebug(),SensorsABTest.initFetch(this.getResultFromServer,this),SensorsABTest.initMethods(this)},setPara:function(e){if(!_.isString(e.url)||"http"!==e.url.slice(0,4))return _.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1;if("https"===location.protocol.slice(0,4)&&"http"===e.url.slice(0,4))return _.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0chttps \u9875\u9762\u5fc5\u987b\u4f7f\u7528 https \u7684 URL"),!1;var t=_.getQueryParam(e.url,"project-key");if(!t)return _.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff08\u5fc5\u987b\u5305\u542b project-key\uff09\uff01"),!1;e.project_key=t;var s=SensorsABTest.verifyStore.para("A/B Testing SDK \u521d\u59cb\u5316",e,{timeout_milliseconds:"not_essential"});return SensorsABTest.para=_.extend({},SensorsABTest.default_para,s.para),_.isBoolean(SensorsABTest.para.collect_bridge_status)||(SensorsABTest.para.collect_bridge_status=!0),_.isNumber(SensorsABTest.para.update_interval)||(SensorsABTest.para.update_interval=6e5),!0},asyncFetch:function(e){SensorsABTest.normalStore.getResultFromServer({para:e,suc:function(t){if(_.isObject(t)&&"SUCCESS"===t.status){var s=SensorsABTest.getExpResult(e);e.callback(s)}else e.callback(e.default_value)},err:function(){e.callback(e.default_value)}})},methods:{asyncFetchABTest:function(e){if(!_.isObject(e))return SensorsABTest.error("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var t=SensorsABTest.verifyStore.para("asyncFetchABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});t.verify_success&&(e=t.para,SensorsABTest.normalStore.asyncFetch(e))},fastFetchABTest:function(e){if(!_.isObject(e))return SensorsABTest.error("fastFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;var t=SensorsABTest.verifyStore.para("fastFetchABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential",callback:"not_essential",timeout_milliseconds:"not_essential",properties:"not_essential"});if(t.verify_success){e=t.para;var s=SensorsABTest.searchLocalExp(e.experiment_id);if(_.isObject(s)){var r=SensorsABTest.getExpResult(e,s);e.callback(r)}else _.log("fastFetchABTest\u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),SensorsABTest.normalStore.asyncFetch(e)}},fetchCacheABTest:function(e){if(_.isObject(e)){var t=SensorsABTest.verifyStore.para("fetchCacheABTest",e,{experiment_id:"essential",value_type:"essential",default_value:"essential"});if(t.verify_success)return SensorsABTest.getExpResult(t.para)}else SensorsABTest.error("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e")}},creatRequestData:function(e){var t="";_.isEmptyObject(SensorsABTest.sd.store._state)||(t=SensorsABTest.sd.store._state._first_id||SensorsABTest.sd.store._state.first_id||SensorsABTest.sd.store._state._distinct_id||SensorsABTest.sd.store._state.distinct_id);var s={anonymous_id:t,platform:SensorsABTest.state.platform,properties:{$is_first_day:_.cookie.getNewUser()}};return _.isObject(e.properties)&&(s.properties=_.extend({},s.properties,e.properties)),SensorsABTest.sd.store._state.first_id&&(s.login_id=SensorsABTest.sd.store.getDistinctId()),s},getResultFromServer:function(e){var t=(e=_.isObject(e)?e:{}).para||{},s=e.suc,r=e.err,a=this.creatRequestData(t);_.ajax({url:SensorsABTest.para.url,type:"POST",data:JSON.stringify(a),credentials:!1,contentType:"application/json",timeout:t.timeout_milliseconds||SensorsABTest.para.timeout_milliseconds,cors:!0,success:function(e){_.log("\u83b7\u53d6\u5230\u670d\u52a1\u7aef\u6570\u636e",e),SensorsABTest.dealResponseData(e),s&&s(e)},error:function(e){_.log("\u670d\u52a1\u7aef\u8bf7\u6c42\u53d1\u9001\u5931\u8d25",e),r&&r()}})}}};window.SensorsDataWebJSSDKPlugin&&"[object Object]"==Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.SensorsABTest=window.SensorsDataWebJSSDKPlugin.SensorsABTest||SensorsABTest:window.SensorsDataWebJSSDKPlugin={SensorsABTest:SensorsABTest};export default SensorsABTest;